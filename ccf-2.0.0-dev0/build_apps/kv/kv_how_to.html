<!doctype html>
<html class="no-js">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />
<link rel="index" title="Index" href="../../genindex.html" /><link rel="search" title="Search" href="../../search.html" /><link rel="next" title="Key-Value Serialisation" href="kv_serialisation.html" /><link rel="prev" title="Key-Value Store" href="index.html" />

    <link rel="shortcut icon" href="../../_static/favicon.ico"/><meta name="generator" content="sphinx-4.1.2, furo 2021.08.11.beta42"/>
        <title>Key-Value Store How-To - CCF documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/furo.css?digest=197f00461d56902ea7ca048ec6e6ba026f62c97b" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/panels-bootstrap.5fd3999ee7762ccc51105388f4a9d115.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/furo-extensions.css?digest=93475b62d1c3bc01323a0eefdc14a62d77b12690" />
    <link rel="stylesheet" type="text/css" href="../../_static/css/custom.css" />
    
    


<style>
  body {
    --color-code-background: #ffffff;
  --color-code-foreground: black;
  
  }
  body[data-theme="dark"] {
    --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
  }
  @media (prefers-color-scheme: dark) {
    body:not([data-theme="light"]) {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
    }
  }
</style>
    <link media="(prefers-color-scheme: dark)" rel="stylesheet" href="../../_static/pygments_dark.css"></head>
  <body>
    
<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
      <path stroke="none" d="M0 0h24v24H0z" />
      <line x1="4" y1="6" x2="20" y2="6" />
      <line x1="10" y1="12" x2="20" y2="12" />
      <line x1="6" y1="18" x2="20" y2="18" />
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-half" viewBox="0 0 24 24">
    <title>Auto light/dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-shadow">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
      <circle cx="12" cy="12" r="9" />
      <path d="M13 12h5" />
      <path d="M13 15h4" />
      <path d="M13 18h1" />
      <path d="M13 9h4" />
      <path d="M13 6h1" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="../../index.html"><div class="brand">CCF  documentation</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
          <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand centered" href="../../index.html">
  
  <div class="sidebar-logo-container">
    <img class="sidebar-logo" src="../../_static/ccf.svg" alt="Logo"/>
  </div>
  
</a>

<script>
  function onVersionChange() {
    window.location.href = document.getElementById("versions").value;
  }

  window.addEventListener("DOMContentLoaded",function(){
      let selectedVersion = "main"
      const thisURL = window.location.toString()
      let indexOfVersion = thisURL.indexOf("ccf-")
      if (indexOfVersion != -1) {
          selectedVersion = thisURL.substring(indexOfVersion, thisURL.indexOf("/", indexOfVersion));
      }
      let sel = document.getElementById("versions");
      if (sel != null) {
          let opts = sel.options;
          for (var opt, j = 0; opt = opts[j]; j++) {
              if (opt.text == selectedVersion) {
                  sel.selectedIndex = j;
                  break;
              }
          }
      }
  }, false);
</script>


<select name="versions" id="versions" class="custom-select custom-select-sm" style="margin: 0em 1em;" onchange="onVersionChange()">
    <option value="../../../main/build_apps/kv/kv_how_to.html">main </option>
    <option value="../../../ccf-2.0.0-dev3/build_apps/kv/kv_how_to.html">ccf-2.0.0-dev3 </option>
    <option value="../../../ccf-2.0.0-dev2/build_apps/kv/kv_how_to.html">ccf-2.0.0-dev2 </option>
    <option value="../../../ccf-2.0.0-dev1/build_apps/kv/kv_how_to.html">ccf-2.0.0-dev1 </option>
    <option value="kv_how_to.html">ccf-2.0.0-dev0 </option>
    <option value="../../../ccf-1.0.8/build_apps/kv/kv_how_to.html">ccf-1.0.8 </option>
    <option value="../../../ccf-1.0.7/build_apps/kv/kv_how_to.html">ccf-1.0.7 </option>
    <option value="../../../ccf-1.0.6/build_apps/kv/kv_how_to.html">ccf-1.0.6 </option>
    <option value="../../../ccf-1.0.5/build_apps/kv/kv_how_to.html">ccf-1.0.5 </option>
    <option value="../../../ccf-1.0.4/build_apps/kv/kv_how_to.html">ccf-1.0.4 </option>
    <option value="../../../ccf-1.0.3/build_apps/kv/kv_how_to.html">ccf-1.0.3 </option>
    <option value="../../../ccf-1.0.2/build_apps/kv/kv_how_to.html">ccf-1.0.2 </option>
    <option value="../../../ccf-1.0.1/build_apps/kv/kv_how_to.html">ccf-1.0.1 </option>
    <option value="../../../ccf-1.0.0/build_apps/kv/kv_how_to.html">ccf-1.0.0 </option>
</select>
<form class="sidebar-search-container" method="get" action="../../search.html" role="search">
  <input class="sidebar-search" placeholder=Search name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <ul class="current">
<li class="toctree-l1 has-children"><a class="reference internal" href="../../overview/index.html">Overview</a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" role="switch" type="checkbox"/><label for="toctree-checkbox-1"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../overview/concepts.html">Concepts</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../overview/release_policy.html">CCF release and support policy</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../overview/governance.html">Governance</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../overview/consensus.html">Consensus Protocols</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../overview/cryptography.html">Cryptography</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../overview/performance.html">Performance</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../overview/threading.html">Threading</a></li>
</ul>
</li>
<li class="toctree-l1 current has-children"><a class="reference internal" href="../index.html">Build Apps</a><input checked="" class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" role="switch" type="checkbox"/><label for="toctree-checkbox-2"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../create_vm.html">Create Azure SGX VM</a></li>
<li class="toctree-l2"><a class="reference internal" href="../install_bin.html">Install CCF</a></li>
<li class="toctree-l2"><a class="reference internal" href="../build_setup.html">CCF Development Setup</a></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../example.html">C++ Application</a><input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" role="switch" type="checkbox"/><label for="toctree-checkbox-3"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../logging_cpp.html">Logging (C++)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../logging_rpc_api.html">Logging RPC API</a></li>
<li class="toctree-l3"><a class="reference internal" href="../logging.html">Logging</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../js_app.html">JavaScript Application</a><input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" role="switch" type="checkbox"/><label for="toctree-checkbox-4"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../js_app_ts.html">TypeScript Application</a></li>
<li class="toctree-l3"><a class="reference internal" href="../js_app_tsoa.html">TypeScript Application using tsoa</a></li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../js_app_bundle.html">JavaScript Application Bundle</a><input class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" role="switch" type="checkbox"/><label for="toctree-checkbox-5"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l4"><a class="reference internal" href="../js_app_ts.html">TypeScript Application</a></li>
<li class="toctree-l4"><a class="reference internal" href="../js_app_tsoa.html">TypeScript Application using tsoa</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../build_app.html">Build and Sign CCF Applications</a></li>
<li class="toctree-l2"><a class="reference internal" href="../run_app.html">Running CCF Applications</a></li>
<li class="toctree-l2"><a class="reference internal" href="../demo.html">End-to-end demo</a></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../auth/index.html">User Authentication</a><input class="toctree-checkbox" id="toctree-checkbox-6" name="toctree-checkbox-6" role="switch" type="checkbox"/><label for="toctree-checkbox-6"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../auth/jwt.html">JWT Authentication</a></li>
<li class="toctree-l3"><a class="reference internal" href="../auth/cert.html">Certificate Authentication</a></li>
<li class="toctree-l3"><a class="reference internal" href="../auth/jwt_ms_example.html">JWT Authentication example using Microsoft Identity Platform</a></li>
</ul>
</li>
<li class="toctree-l2 current has-children"><a class="reference internal" href="index.html">Key-Value Store</a><input checked="" class="toctree-checkbox" id="toctree-checkbox-7" name="toctree-checkbox-7" role="switch" type="checkbox"/><label for="toctree-checkbox-7"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul class="current">
<li class="toctree-l3 current current-page"><a class="current reference internal" href="#">Key-Value Store How-To</a></li>
<li class="toctree-l3"><a class="reference internal" href="kv_serialisation.html">Key-Value Serialisation</a></li>
<li class="toctree-l3"><a class="reference internal" href="api.html">Key-Value Store API</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../upgrading_app.html">Upgrade Your Application</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api.html">Developer API</a></li>
<li class="toctree-l2"><a class="reference internal" href="../crypto.html">Cryptography API</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../use_apps/index.html">Use Apps</a><input class="toctree-checkbox" id="toctree-checkbox-8" name="toctree-checkbox-8" role="switch" type="checkbox"/><label for="toctree-checkbox-8"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../use_apps/issue_commands.html">Issuing Commands</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../use_apps/verify_tx.html">Verifying Transaction</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../use_apps/verify_quote.html">Verifying Quote</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../use_apps/python_tutorial.html">Python Client Tutorial</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../use_apps/python_api.html">Python Client API</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../use_apps/rpc_api.html">RPC API</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../operations/index.html">Operations</a><input class="toctree-checkbox" id="toctree-checkbox-9" name="toctree-checkbox-9" role="switch" type="checkbox"/><label for="toctree-checkbox-9"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../operations/run_setup.html">Setup CCF Runtime Environment</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../operations/start_network.html">Running a CCF Service</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../operations/ledger_snapshot.html">Ledger and Snapshots</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../operations/recovery.html">Disaster Recovery</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../operations/node_output.html">Node Output</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../operations/resource_usage.html">Resource Usage</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../operations/operator_rpc_api.html">Operator RPC API</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../governance/index.html">Governance</a><input class="toctree-checkbox" id="toctree-checkbox-10" name="toctree-checkbox-10" role="switch" type="checkbox"/><label for="toctree-checkbox-10"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../governance/proposals.html">Proposing and Voting for a Proposal</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../governance/open_network.html">Opening a Network</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../governance/accept_recovery.html">Accepting Recovery and Submitting Shares</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../governance/common_member_operations.html">Common Governance Operations</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../governance/adding_member.html">Adding New Members</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../governance/hsm_keys.html">Using Member Keys Stored in HSM</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../governance/member_rpc_api.html">Member RPC API</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../governance/js_gov.html">JavaScript Governance</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../audit/index.html">Audit</a><input class="toctree-checkbox" id="toctree-checkbox-11" name="toctree-checkbox-11" role="switch" type="checkbox"/><label for="toctree-checkbox-11"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../audit/builtin_maps.html">Built-in Maps</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../audit/merkle_tree.html">Merkle Tree</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../audit/ledger.html">Ledger</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../audit/python_library.html">Python Library</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../contribute/index.html">Contribute</a><input class="toctree-checkbox" id="toctree-checkbox-12" name="toctree-checkbox-12" role="switch" type="checkbox"/><label for="toctree-checkbox-12"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../create_vm.html">Create Azure SGX VM</a></li>
<li class="toctree-l2"><a class="reference internal" href="../build_setup.html">CCF Development Setup</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../contribute/build_ccf.html">Build CCF from Source</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../contribute/release_ccf.html">Release or patch a CCF release</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../glossary.html">Glossary</a></li>
</ul>

</div>
</div>
      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <article role="main">
        <div class="content-icon-container">
          <div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
              <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <section id="key-value-store-how-to">
<h1>Key-Value Store How-To<a class="headerlink" href="#key-value-store-how-to" title="Permalink to this headline">¶</a></h1>
<p>The Key-Value <a class="reference internal" href="api.html#_CPPv4N2kv5StoreE" title="kv::Store"><code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">kv::Store</span></code></a> is a collection of <code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">kv::Maps</span></code> that are available from all the end-points of an application. There is one unique <code class="docutils literal notranslate"><span class="pre">Store</span></code> created in the enclave of each node that is passed to the constructor of all applications.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">Store</span><span class="w"> </span><span class="n">tables</span><span class="p">;</span><span class="w"></span>
</pre></div>
</div>
<section id="creating-a-map">
<h2>Creating a Map<a class="headerlink" href="#creating-a-map" title="Permalink to this headline">¶</a></h2>
<p>A <a class="reference internal" href="api.html#_CPPv4I00EN2kv3MapE" title="kv::Map"><code class="xref cpp cpp-type docutils literal notranslate"><span class="pre">kv::Map</span></code></a> (often referred to as a <code class="docutils literal notranslate"><span class="pre">Table</span></code>) is a collection of key-value pairs of a given type. The <a class="reference internal" href="api.html#_CPPv4I00EN2kv3MapE" title="kv::Map"><code class="xref cpp cpp-type docutils literal notranslate"><span class="pre">kv::Map</span></code></a> itself is identified by its name, which is used to lookup the map <a class="reference internal" href="api.html#_CPPv4I00EN2kv3MapE" title="kv::Map"><code class="xref cpp cpp-type docutils literal notranslate"><span class="pre">kv::Map</span></code></a> in a <cite>cpp:class:`kv::Store</cite> during a transaction.</p>
<p>If a <code class="docutils literal notranslate"><span class="pre">Map</span></code> with the given name did not previously exist, it will be created in this transaction..</p>
<p>A <code class="docutils literal notranslate"><span class="pre">Map</span></code> can either be created as private (default) or public. Public map’s names begin with a <code class="docutils literal notranslate"><span class="pre">public:</span></code> prefix, any any other name indicates a private map. Transactions on private maps are written to the ledger in encrypted form and can only be decrypted in the enclave of the nodes that have joined the network. Transactions on public maps are written to the ledger as plaintext and can be read from outside the enclave (only their integrity is protected). The security domain of a map (public or private) cannot be changed after its creation, since this is encoded in the map’s name. Public and private maps with similar names are distinct; writes to “public:foo” have no impact on “foo”, and vice versa.</p>
</section>
<section id="accessing-the-transaction">
<h2>Accessing the Transaction<a class="headerlink" href="#accessing-the-transaction" title="Permalink to this headline">¶</a></h2>
<p>A <a class="reference internal" href="api.html#_CPPv4N2kv2TxE" title="kv::Tx"><code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">kv::Tx</span></code></a> corresponds to the atomic operations that can be executed on the Key-Value <code class="docutils literal notranslate"><span class="pre">Store</span></code>. A transaction can affect one or multiple <code class="docutils literal notranslate"><span class="pre">Map</span></code> and are automatically committed by CCF once the endpoint’s handler returns successfully.</p>
<p>A single <code class="docutils literal notranslate"><span class="pre">Transaction</span></code> (<code class="docutils literal notranslate"><span class="pre">tx</span></code>) is passed to each endpoint of an application and should be used to interact with the Key-Value <code class="docutils literal notranslate"><span class="pre">Store</span></code>.</p>
<p>When the end-point successfully completes, the node on which the end-point was triggered attempts to commit the transaction to apply the changes to the Store. Once the transaction is committed successfully, it is automatically replicated by CCF and should globally commit.</p>
<p>For each <a class="reference internal" href="api.html#_CPPv4I00EN2kv3MapE" title="kv::Map"><code class="xref cpp cpp-type docutils literal notranslate"><span class="pre">kv::Map</span></code></a> that a transaction wants to write to or read from, a <a class="reference internal" href="api.html#_CPPv4I0000EN2kv9MapHandleE" title="kv::MapHandle"><code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">kv::MapHandle</span></code></a> must first be acquired. These are acquired from the <a class="reference internal" href="api.html#_CPPv4I0EN2kv2Tx2rwEPN1M6HandleER1M" title="kv::Tx::rw"><code class="xref cpp cpp-func docutils literal notranslate"><span class="pre">kv::Tx::rw()</span></code></a> (<cite>read-write</cite>) method. These may be acquired either by name (in which case the desired type must be explicitly specified as a template parameter), or by using a <a class="reference internal" href="api.html#_CPPv4I00EN2kv3MapE" title="kv::Map"><code class="xref cpp cpp-type docutils literal notranslate"><span class="pre">kv::Map</span></code></a> instance which defines both the map’s name and key-value types.</p>
<p>By name:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="c1">// Handle for map1</span>
<span class="k">auto</span><span class="w"> </span><span class="n">map1_handle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tx</span><span class="p">.</span><span class="n">rw</span><span class="o">&lt;</span><span class="n">kv</span><span class="o">::</span><span class="n">Map</span><span class="o">&lt;</span><span class="n">string</span><span class="p">,</span><span class="w"> </span><span class="n">string</span><span class="o">&gt;&gt;</span><span class="p">(</span><span class="s">"map1"</span><span class="p">);</span><span class="w"></span>

<span class="c1">// Handles for 2 other maps, one public and one private, with different types</span>
<span class="k">auto</span><span class="w"> </span><span class="n">map2_handle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tx</span><span class="p">.</span><span class="n">rw</span><span class="o">&lt;</span><span class="n">kv</span><span class="o">::</span><span class="n">Map</span><span class="o">&lt;</span><span class="n">string</span><span class="p">,</span><span class="w"> </span><span class="kt">uint64_t</span><span class="o">&gt;&gt;</span><span class="p">(</span><span class="s">"public:map2"</span><span class="p">);</span><span class="w"></span>
<span class="k">auto</span><span class="w"> </span><span class="n">map3_handle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tx</span><span class="p">.</span><span class="n">rw</span><span class="o">&lt;</span><span class="n">kv</span><span class="o">::</span><span class="n">Map</span><span class="o">&lt;</span><span class="kt">uint64_t</span><span class="p">,</span><span class="w"> </span><span class="n">MyCustomClass</span><span class="o">&gt;&gt;</span><span class="p">(</span><span class="s">"map3"</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
<p>By <code class="docutils literal notranslate"><span class="pre">Map</span></code>:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">kv</span><span class="o">::</span><span class="n">Map</span><span class="o">&lt;</span><span class="n">string</span><span class="p">,</span><span class="w"> </span><span class="n">string</span><span class="o">&gt;</span><span class="w"> </span><span class="n">map_priv</span><span class="p">(</span><span class="s">"map1"</span><span class="p">);</span><span class="w"></span>
<span class="k">auto</span><span class="w"> </span><span class="n">map1_handle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tx</span><span class="p">.</span><span class="n">rw</span><span class="p">(</span><span class="n">map_priv</span><span class="p">);</span><span class="w"></span>

<span class="n">kv</span><span class="o">::</span><span class="n">Map</span><span class="o">&lt;</span><span class="n">string</span><span class="p">,</span><span class="w"> </span><span class="n">stuint64_tring</span><span class="o">&gt;</span><span class="w"> </span><span class="n">map_pub</span><span class="p">(</span><span class="s">"public:map2"</span><span class="p">);</span><span class="w"></span>
<span class="k">auto</span><span class="w"> </span><span class="n">map2_handle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tx</span><span class="p">.</span><span class="n">rw</span><span class="p">(</span><span class="n">map_pub</span><span class="p">);</span><span class="w"></span>

<span class="n">kv</span><span class="o">::</span><span class="n">Map</span><span class="o">&lt;</span><span class="kt">uint64_t</span><span class="p">,</span><span class="w"> </span><span class="n">string</span><span class="o">&gt;</span><span class="w"> </span><span class="n">MyCustomClass</span><span class="p">(</span><span class="s">"map3"</span><span class="p">);</span><span class="w"></span>
<span class="k">auto</span><span class="w"> </span><span class="n">map3_handle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tx</span><span class="p">.</span><span class="n">rw</span><span class="p">(</span><span class="n">map_priv_int</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
<p>The latter approach introduces a named binding between the map’s name and the types of its keys and values, reducing the chance for errors where code attempts to read a map with the wrong type.</p>
<p>As noted above, this access may cause the <code class="docutils literal notranslate"><span class="pre">Map</span></code> to be created, if it did not previously. In fact all <code class="docutils literal notranslate"><span class="pre">Maps</span></code> are created like this, in the first transaction in which they are written to. Within a transaction, a newly created <code class="docutils literal notranslate"><span class="pre">Map</span></code> behaves exactly the same as an existing <code class="docutils literal notranslate"><span class="pre">Map</span></code> with no keys - the framework views these as semantically identical, and offers no way for the application logic to tell them apart. Any writes to a newly created <code class="docutils literal notranslate"><span class="pre">Map</span></code> will be persisted when the transaction commits, and future transactions will be able to access this <code class="docutils literal notranslate"><span class="pre">Map</span></code> by name to read those writes.</p>
</section>
<section id="accessing-map-content-via-a-handle">
<h2>Accessing Map content via a Handle<a class="headerlink" href="#accessing-map-content-via-a-handle" title="Permalink to this headline">¶</a></h2>
<p>Once a <a class="reference internal" href="api.html#_CPPv4I0000EN2kv9MapHandleE" title="kv::MapHandle"><code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">kv::MapHandle</span></code></a> on a specific <a class="reference internal" href="api.html#_CPPv4I00EN2kv3MapE" title="kv::Map"><code class="xref cpp cpp-type docutils literal notranslate"><span class="pre">kv::Map</span></code></a> has been obtained, it is possible to:</p>
<ul class="simple">
<li><p>test (<code class="xref cpp cpp-func docutils literal notranslate"><span class="pre">kv::MapHandle::has()</span></code>) whether a key has any associated value;</p></li>
<li><p>read (<code class="xref cpp cpp-func docutils literal notranslate"><span class="pre">kv::MapHandle::get()</span></code>) the value associated with a key;</p></li>
<li><p>write (<code class="xref cpp cpp-func docutils literal notranslate"><span class="pre">kv::MapHandle::put()</span></code>) a new value for a key;</p></li>
<li><p>delete (<code class="xref cpp cpp-func docutils literal notranslate"><span class="pre">kv::MapHandle::remove()</span></code>) a key and its current value;</p></li>
<li><p>iterate (<code class="xref cpp cpp-func docutils literal notranslate"><span class="pre">kv::MapHandle::foreach()</span></code>) through all key-value pairs.</p></li>
</ul>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="c1">// Writing to a handle</span>
<span class="n">map1_handle1</span><span class="o">-&gt;</span><span class="n">put</span><span class="p">(</span><span class="s">"key1"</span><span class="p">,</span><span class="w"> </span><span class="s">"value1"</span><span class="p">);</span><span class="w"></span>

<span class="c1">// Reading presence of a key</span>
<span class="kt">bool</span><span class="w"> </span><span class="n">has_key_1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">map1_handle</span><span class="o">-&gt;</span><span class="n">has</span><span class="p">(</span><span class="s">"key1"</span><span class="p">);</span><span class="w"></span>
<span class="n">assert</span><span class="p">(</span><span class="n">has_key_1</span><span class="p">);</span><span class="w"></span>

<span class="c1">// Reading a value</span>
<span class="n">std</span><span class="o">::</span><span class="n">optional</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span><span class="w"> </span><span class="n">read_val</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">map1_handle1</span><span class="o">-&gt;</span><span class="n">get</span><span class="p">(</span><span class="s">"key1"</span><span class="p">);</span><span class="w"></span>
<span class="n">assert</span><span class="p">(</span><span class="n">read_val</span><span class="p">.</span><span class="n">has_value</span><span class="p">());</span><span class="w"></span>
<span class="n">assert</span><span class="p">(</span><span class="n">read_val</span><span class="p">.</span><span class="n">value</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">"value1"</span><span class="p">);</span><span class="w"></span>

<span class="c1">// Deleting a key</span>
<span class="n">map1_handle1</span><span class="o">-&gt;</span><span class="n">remove</span><span class="p">(</span><span class="s">"key1"</span><span class="p">);</span><span class="w"></span>

<span class="c1">// Reading a deleted/non-existent key</span>
<span class="n">assert</span><span class="p">(</span><span class="o">!</span><span class="n">map_handle1</span><span class="o">-&gt;</span><span class="n">has</span><span class="p">(</span><span class="s">"key1"</span><span class="p">));</span><span class="w"></span>
<span class="n">read_val</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">map1_handle1</span><span class="o">-&gt;</span><span class="n">get</span><span class="p">(</span><span class="s">"key1"</span><span class="p">);</span><span class="w"></span>
<span class="n">assert</span><span class="p">(</span><span class="o">!</span><span class="n">read_val</span><span class="p">.</span><span class="n">has_value</span><span class="p">());</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="read-write-safety">
<h2>Read/Write safety<a class="headerlink" href="#read-write-safety" title="Permalink to this headline">¶</a></h2>
<p>If you are only reading from or only writing to a given <a class="reference internal" href="api.html#_CPPv4I00EN2kv3MapE" title="kv::Map"><code class="xref cpp cpp-type docutils literal notranslate"><span class="pre">kv::Map</span></code></a> you can retrieve a <cite>read-only</cite> or <cite>write-only</cite> handle for it, turning unexpected reads/writes (which would introduce unintended dependencies between transactions) into compile-time errors. Instead of calling <a class="reference internal" href="api.html#_CPPv4I0EN2kv2Tx2rwEPN1M6HandleER1M" title="kv::Tx::rw"><code class="xref cpp cpp-func docutils literal notranslate"><span class="pre">kv::Tx::rw()</span></code></a> to get a handle which can both read and write, you can call <code class="xref cpp cpp-func docutils literal notranslate"><span class="pre">kv::Tx::ro()</span></code> to acquire a read-only handle or <a class="reference internal" href="api.html#_CPPv4I0EN2kv2Tx2woEPN1M15WriteOnlyHandleER1M" title="kv::Tx::wo"><code class="xref cpp cpp-func docutils literal notranslate"><span class="pre">kv::Tx::wo()</span></code></a> to acquire a write-only handle.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="c1">// Read-only handle for map_priv</span>
<span class="k">auto</span><span class="w"> </span><span class="n">map1_handle_ro</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tx</span><span class="p">.</span><span class="n">ro</span><span class="p">(</span><span class="n">map_priv</span><span class="p">);</span><span class="w"></span>

<span class="c1">// Reading from that handle</span>
<span class="k">auto</span><span class="w"> </span><span class="n">v1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">map1_handle_ro</span><span class="o">-&gt;</span><span class="n">get</span><span class="p">(</span><span class="s">"key1"</span><span class="p">);</span><span class="w"></span>
<span class="n">assert</span><span class="p">(</span><span class="n">v1</span><span class="p">.</span><span class="n">value</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">"value1"</span><span class="p">);</span><span class="w"></span>

<span class="c1">// Writes are blocked at compile time</span>
<span class="n">map1_handle_ro</span><span class="o">-&gt;</span><span class="n">put</span><span class="p">(</span><span class="s">"key1"</span><span class="p">,</span><span class="w"> </span><span class="s">"value2"</span><span class="p">);</span><span class="w"> </span><span class="c1">// Does not compile</span>
<span class="n">map1_handle_ro</span><span class="o">-&gt;</span><span class="n">remove</span><span class="p">(</span><span class="s">"key1"</span><span class="p">);</span><span class="w"> </span><span class="c1">// Does not compile</span>


<span class="c1">// Write-only handle for the same map</span>
<span class="k">auto</span><span class="w"> </span><span class="n">map1_handle_wo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tx</span><span class="p">.</span><span class="n">wo</span><span class="p">(</span><span class="n">map_priv</span><span class="p">);</span><span class="w"></span>

<span class="c1">// Write to that handle</span>
<span class="n">map1_handle_wo</span><span class="o">-&gt;</span><span class="n">put</span><span class="p">(</span><span class="s">"key1"</span><span class="p">,</span><span class="w"> </span><span class="s">"value2"</span><span class="p">);</span><span class="w"></span>

<span class="c1">// Reads are blocked at compile time</span>
<span class="n">map1_handle_wo</span><span class="o">-&gt;</span><span class="n">has</span><span class="p">(</span><span class="s">"key1"</span><span class="p">);</span><span class="w"> </span><span class="c1">// Does not compile</span>
<span class="n">map1_handle_wo</span><span class="o">-&gt;</span><span class="n">get</span><span class="p">(</span><span class="s">"key1"</span><span class="p">);</span><span class="w"> </span><span class="c1">// Does not compile</span>
</pre></div>
</div>
<p>Note that, as in the sample above, it is possible to acquire different kinds of handles at different points within your transaction’s execution. So if you need to read in one location and write in another you can retrieve multiple distinct handles and get local type-safety, while the resulting transaction correctly handles all reads and writes made.</p>
</section>
<section id="removing-a-key">
<h2>Removing a key<a class="headerlink" href="#removing-a-key" title="Permalink to this headline">¶</a></h2>
<p>If a Key-Value pair was written to a <code class="docutils literal notranslate"><span class="pre">Map</span></code> by a previous <code class="docutils literal notranslate"><span class="pre">Transaction</span></code>, it is possible to delete this key. Because of the append-only nature of the <code class="docutils literal notranslate"><span class="pre">Store</span></code>, this Key-Value pair is not actually removed from the <code class="docutils literal notranslate"><span class="pre">Map</span></code> but instead explicitly marked as deleted from the version that the corresponding <code class="docutils literal notranslate"><span class="pre">Transaction</span></code> is committed at.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="c1">// In transaction A, assuming that "key1" has already been committed</span>
<span class="k">auto</span><span class="w"> </span><span class="n">handle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tx</span><span class="p">.</span><span class="n">rw</span><span class="p">(</span><span class="n">map_priv</span><span class="p">);</span><span class="w"></span>
<span class="k">auto</span><span class="w"> </span><span class="n">v</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">handle</span><span class="o">-&gt;</span><span class="n">get</span><span class="p">(</span><span class="s">"key1"</span><span class="p">);</span><span class="w"> </span><span class="c1">// v.value() == "value1"</span>
<span class="n">handle</span><span class="o">-&gt;</span><span class="n">remove</span><span class="p">(</span><span class="s">"key1"</span><span class="p">);</span><span class="w"></span>
<span class="k">auto</span><span class="w"> </span><span class="n">rc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tx</span><span class="p">.</span><span class="n">commit</span><span class="p">();</span><span class="w"></span>

<span class="c1">// In a later transaction B, which sees the state after A is applied</span>
<span class="k">auto</span><span class="w"> </span><span class="n">handle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tx</span><span class="p">.</span><span class="n">rw</span><span class="p">(</span><span class="n">map_priv</span><span class="p">);</span><span class="w"></span>
<span class="k">auto</span><span class="w"> </span><span class="n">v1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">handle</span><span class="o">-&gt;</span><span class="n">get</span><span class="p">(</span><span class="s">"key1"</span><span class="p">);</span><span class="w"> </span><span class="c1">// v1.has_value() == false</span>
</pre></div>
</div>
</section>
<section id="global-commit">
<h2>Global commit<a class="headerlink" href="#global-commit" title="Permalink to this headline">¶</a></h2>
<p>A <code class="docutils literal notranslate"><span class="pre">Map</span></code> is globally committed at a specific <a class="reference internal" href="api.html#_CPPv4N2kv7VersionE" title="kv::Version"><code class="xref cpp cpp-type docutils literal notranslate"><span class="pre">kv::Version</span></code></a> when it is not possible to access the state of that <code class="docutils literal notranslate"><span class="pre">Map</span></code> prior to that version.
This is useful when it is certain that the state of the <code class="docutils literal notranslate"><span class="pre">Store</span></code> prior to a specific version will never need to be read or modified. A transaction is automatically globally committed once the consensus protocol has established that a majority of nodes in the CCF network have successfully received and acknowledged that transaction.</p>
<p>The <code class="xref cpp cpp-func docutils literal notranslate"><span class="pre">kv::MapHandle::get_globally_committed()</span></code> member function returns the value of a key that we know has been globally committed.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="c1">// Assuming that "key1":"value1" has already been committed</span>
<span class="k">auto</span><span class="w"> </span><span class="n">handle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tx</span><span class="p">.</span><span class="n">rw</span><span class="p">(</span><span class="n">map_priv</span><span class="p">);</span><span class="w"></span>

<span class="c1">// "key1" has not yet been globally committed</span>
<span class="k">auto</span><span class="w"> </span><span class="n">v</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">handle</span><span class="p">.</span><span class="n">get_globally_committed</span><span class="p">(</span><span class="s">"key1"</span><span class="p">);</span><span class="w"></span>
<span class="n">assert</span><span class="p">(</span><span class="n">v</span><span class="p">.</span><span class="n">has_value</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">false</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="c1">// Meanwhile, the CCF network globally commits the transaction in which "key1" was written</span>
<span class="k">auto</span><span class="w"> </span><span class="n">v1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">handle</span><span class="p">.</span><span class="n">get_globally_committed</span><span class="p">(</span><span class="s">"key1"</span><span class="p">);</span><span class="w"> </span><span class="c1">// v1.has_value() == "value1"</span>
<span class="n">assert</span><span class="p">(</span><span class="n">v</span><span class="p">.</span><span class="n">value</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">"value1"</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
</section>
<hr class="docutils"/>
<section id="miscellaneous">
<h2>Miscellaneous<a class="headerlink" href="#miscellaneous" title="Permalink to this headline">¶</a></h2>
<section id="foreach">
<h3><code class="docutils literal notranslate"><span class="pre">foreach()</span></code><a class="headerlink" href="#foreach" title="Permalink to this headline">¶</a></h3>
<p>Values can only be retrieved directly (<code class="xref cpp cpp-func docutils literal notranslate"><span class="pre">kv::MapHandle::get()</span></code>) for a given target key. However, it is sometimes necessary to access unknown keys, or to iterate through all Key-Value pairs.</p>
<p>CCF offers a member function <code class="xref cpp cpp-func docutils literal notranslate"><span class="pre">kv::MapHandle::foreach()</span></code> to iterate over all the elements written to that <code class="docutils literal notranslate"><span class="pre">Map</span></code> so far, and run a lambda function for each Key-Value pair. Note that a <code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">kv::MapHandle::foreach</span></code> loop can be ended early by returning <code class="docutils literal notranslate"><span class="pre">false</span></code> from this lambda, while <code class="docutils literal notranslate"><span class="pre">true</span></code> should be returned to continue iteration.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">using</span><span class="w"> </span><span class="k">namespace</span><span class="w"> </span><span class="nn">std</span><span class="p">;</span><span class="w"></span>

<span class="c1">// Assuming that "key1":"value1" and "key2":"value2" have already been committed</span>
<span class="k">auto</span><span class="w"> </span><span class="n">handle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tx</span><span class="p">.</span><span class="n">rw</span><span class="p">(</span><span class="n">map_priv</span><span class="p">);</span><span class="w"></span>

<span class="c1">// Outputs:</span>
<span class="c1">//  key: key1 - value: value1</span>
<span class="c1">//  key: key2 - value: value2</span>
<span class="n">handle</span><span class="o">-&gt;</span><span class="n">foreach</span><span class="p">([](</span><span class="k">const</span><span class="w"> </span><span class="n">string</span><span class="o">&amp;</span><span class="w"> </span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">string</span><span class="o">&amp;</span><span class="w"> </span><span class="n">value</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">" key: "</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">" - value: "</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">endl</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="cm">/* condition*/</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">});</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="applying-and-reverting-writes">
<h3>Applying and reverting writes<a class="headerlink" href="#applying-and-reverting-writes" title="Permalink to this headline">¶</a></h3>
<p>Changes to the <code class="docutils literal notranslate"><span class="pre">Store</span></code> are made by atomic transactions. For a given <a class="reference internal" href="api.html#_CPPv4N2kv2TxE" title="kv::Tx"><code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">kv::Tx</span></code></a>, either all of its writes are applied, or none are. Only applied writes are replicated and may be globally committed. Transactions may be abandoned without applying their writes - their changes will never be seen by other transactions.</p>
<p>By default CCF decides which transactions are successful (so should be applied to the persistent store) by looking at the status code contained in the response: all transactions producing <code class="docutils literal notranslate"><span class="pre">2xx</span></code> status codes will be applied, while any other status code will be treated as an error and will <cite>not</cite> be applied to the persistent store. If this behaviour is not desired, for instance when an app wants to log incoming requests even though they produce an error, then it can be dynamically overridden by explicitly telling CCF whether it should apply a given transaction:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">args</span><span class="p">.</span><span class="n">rpc_ctx</span><span class="o">-&gt;</span><span class="n">set_response_status</span><span class="p">(</span><span class="n">HTTP_STATUS_FORBIDDEN</span><span class="p">);</span><span class="w"></span>
<span class="k">auto</span><span class="w"> </span><span class="n">handle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tx</span><span class="p">.</span><span class="n">rw</span><span class="p">(</span><span class="n">forbidden_requests</span><span class="p">);</span><span class="w"></span>

<span class="c1">// Log details of forbidden request</span>
<span class="n">handle</span><span class="o">-&gt;</span><span class="n">put</span><span class="p">(...);</span><span class="w"></span>

<span class="w"> </span><span class="c1">// Apply this, even though it has an error response</span>
<span class="n">args</span><span class="p">.</span><span class="n">rpc_ctx</span><span class="o">-&gt;</span><span class="n">set_apply_writes</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
</section>
</section>
</section>

      </article>
      <footer>
        
        <div class="related-pages">
          <a class="next-page" href="kv_serialisation.html">
              <div class="page-info">
                <div class="context">
                  <span>Next</span>
                </div>
                <div class="title">Key-Value Serialisation</div>
              </div>
              <svg><use href="#svg-arrow-right"></use></svg>
            </a>
          <a class="prev-page" href="index.html">
              <svg><use href="#svg-arrow-right"></use></svg>
              <div class="page-info">
                <div class="context">
                  <span>Previous</span>
                </div>
                
                <div class="title">Key-Value Store</div>
                
              </div>
            </a>
        </div>

        <div class="related-information">
              Copyright &#169; 2018, Microsoft Research
            |
            Built with <a href="https://www.sphinx-doc.org/">Sphinx</a>
              and
              <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
              <a href="https://github.com/pradyunsg/furo">Furo theme</a>.
            |
            <a class="muted-link" href="../../_sources/build_apps/kv/kv_how_to.rst.txt"
               rel="nofollow">
              Show Source
            </a>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer">
      
      
      <div class="toc-sticky toc-scroll">
        <div class="toc-title-container">
          <span class="toc-title">
            Contents
          </span>
        </div>
        <div class="toc-tree-container">
          <div class="toc-tree">
            <ul>
<li><a class="reference internal" href="#">Key-Value Store How-To</a><ul>
<li><a class="reference internal" href="#creating-a-map">Creating a Map</a></li>
<li><a class="reference internal" href="#accessing-the-transaction">Accessing the Transaction</a></li>
<li><a class="reference internal" href="#accessing-map-content-via-a-handle">Accessing Map content via a Handle</a></li>
<li><a class="reference internal" href="#read-write-safety">Read/Write safety</a></li>
<li><a class="reference internal" href="#removing-a-key">Removing a key</a></li>
<li><a class="reference internal" href="#global-commit">Global commit</a></li>
<li><a class="reference internal" href="#miscellaneous">Miscellaneous</a><ul>
<li><a class="reference internal" href="#foreach"><code class="docutils literal notranslate"><span class="pre">foreach()</span></code></a></li>
<li><a class="reference internal" href="#applying-and-reverting-writes">Applying and reverting writes</a></li>
</ul>
</li>
</ul>
</li>
</ul>

          </div>
        </div>
      </div>
      
      
    </aside>
  </div>
</div><script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/scripts/main.js"></script>
    <script src="../../_static/clipboard.min.js"></script>
    <script src="../../_static/copybutton.js"></script>
    <script src="https://unpkg.com/mermaid/dist/mermaid.min.js"></script>
    <script>mermaid.initialize({startOnLoad:true});

// Remove height from all mermaid diagrams
window.addEventListener(
  'load',
  function() {
    let nodes = document.querySelectorAll('.mermaid');
    for (let i = 0; i < nodes.length; i++) {
      const element = nodes[i];
      const svg = element.firstChild;
      svg.removeAttribute('height');
    }
  },
  false
);</script>
    <script src="https://kit.fontawesome.com/c75a35380d.js"></script>
    </body>
</html>